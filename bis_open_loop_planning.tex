\section{Open-loop planning via H-steps ahead predictions}
\label{sec:open_loop_planning}
The proposed approach requires the presence of $H+1$ versions of the matrix $\bP$ at each grid point of the discretized problem. One of these versions is initialized with $\bar{\bP}_0$, while the others represent the evolution of matrices that were initialized at previous grid points, from 1 to $H$ steps earlier. This ensures that at each step it is possible to find a covariance matrix evolved for $H$ steps and use it to robustify the constraints. The initialization of the covariance matrix is necessary due to its divergent dynamics. In fact, without a feedback control, the error on the position and orientation of the body reference frame can only increase along the track, compromising the conditioning of the matrix. 

\subsection{Discretization via direct collocation}
\label{sec:discretization}

The nonlinear optimal control problem~\eqref{eq:OCPcost} can be discretized by applying a suitable collocation integrator obtaining the following nonlinear program (NLP) 
\begin{alignat}{3}
	\underset{\bmu_k,\bxi_k, \bu_k, \bP_k,\bz_k}{\text{minimize}} \,
	& & & J_k(\bmu_k,\bxi_k, \bu_k) & & \label{eq:DOCPcost} \\
	\hspace*{-2.0 cm}\text{s.t.} \quad
	& \bzero      & = & \; \bPsimu_k(\bmu_{k-1},\bmu_k,\bxi_k, \bu_k,\bz_k),
	& \quad & k = 1,\ldots, N \label{eq:DOCPdyn} \\
	& \bmu_0      & = & \; \bar{\bmu}_0
	& & \label{eq:DOCPdynIC} \\
	& \bzero      & = & \; \bPsiP_k(\bmu_k,\bxi_k, \bu_k, \bP_{k-1}^{j-1},\bP_k^j,\bSi_k^j,\bz_k),
	& \quad & \substack{k = 1,\ldots, N; \; \\ j=1,\ldots,H;\;} \label{eq:DOCPdPopenloop} \\
	& \bP_0^j       & = & \; \bar{\bP}_0 \succeq 0
	& \quad & j=0,\ldots,H; \; \label{eq:DOCPdPIC} \\
	& \bP_k^0       & = & \; \bar{\bP}_0 \succeq 0
	& \quad & k = 1,\ldots, N; \; \label{eq:DOCPdPinit} \\
	& \bzero      & = & \; \bOm_k(\bmu_k,\bxi_k, \bu_k,\bz_k),
	& \quad & k = 0,\ldots, N \label{eq:DOCPpath} \\
	& 0           & \geq & \; h_i(\bmu_k, \bu_k, \bz_k) + \be_i(\bmu_k, \bu_k, \bP_k^H, \bz_k),
	& \quad & k = 1,\ldots, N;\; i \in \calI \label{eq:DOCPconstraintsopenloop}
\end{alignat}
To perform the discretization, the track centerline is parameterized using a curvilinear abscissa $\alpha \in [0,1]$, and uniformly sampled at $N+1$ points $\alpha_0, \ldots, \alpha_N$.
Accordingly, $\bmu_k$ denotes the mean state at grid node $\alpha_k$, while $\bu_k$ and $\bz_k$ are assumed to be piecewise constant over each interval $[\al_k, \al_{k+1}]$.
These represent the controls and the algebraic variables, respectively. The $\bz_k$'s are introduced as direct handles for physically meaningful quantities such contact forces. 
Similarly, $\bP_k^j$ represents the $j$-th version of the covariance matrix at the $k$-th node.
Following the direct collocation approach, both the mean and covariance state trajectories are approximated, in the $k$-th interval, with polynomials $\pi_k(\tau)$, defined on the unit interval $\tau\in[0,1]$, and then scaled to match the width $h_k$ of the corresponding time step. On the unit interval, we select $d$ collocation points $\tau_1, \ldots, \tau_d$, associated with as many collocation states. Accordingly, we define $\bxi_k$ and $\bSi_k^j$ as the mean states and covariance matrices at the $d$ collocation points within each interval $[\al_k, \al_{k+1}]$, respectively. Therefore, $\bxi_k =
(\bxi_{k,1}, \ldots, \bxi_{k,d})$, and similarly $\bSi_k^j=(\bSi_{k,1}^j, \ldots, \bSi_{k,d}^j)$. 
Equations~\eqref{eq:DOCPdyn} and~\eqref{eq:DOCPdPopenloop} represent the collocation and continuity equations for mean and covariance, respectively, with initial conditions represented by~\eqref{eq:DOCPdynIC} and~\eqref{eq:DOCPdPIC}. 
Eq.~\eqref{eq:DOCPdPinit} is needed to initialize the covariance matrices that evolved for $H$ step, as previously described. 
Eqs.~\eqref{eq:DOCPpath} are path equality constraints and~\eqref{eq:DOCPconstraintsopenloop} are the robustified inequality constraints.
 
A schematic representation of the approach used to manage the $H+1$ versions of the covariance matrix is shown in Figure \ref{fig:DOCPgrid}, where the dashed rectangle represent the $k$-th step at which the constraints are being formulated. At each grid point, two versions of the covariance matrix are highlighted: $\bP^0_k$ (red node), which is the version to be initialized, and $\bP^H_k$ (green node), which is the most propagated version used to formulate the robust constraints in Eq.~\eqref{eq:DOCPconstraintsopenloop}.

In certain cases~\cite{Gillis:PracticalMethodsApproximate:2015}, positive-definiteness-preserving Lyapunov discretization schemes are used in~\eqref{eq:DOCPdPopenloop}. However, for sufficiently fine discretization, we found that integrating only the lower triangular part of $\bP(t)$ in~\eqref{eq:OCPdPIC}  (and reconstructing its strictly upper part accordingly), ensures that all $\bP_k^j$ remain symmetric and positive definite when the initial $\bP_0$ is symmetric and positive definite. In all our tests direct collocation with cubic polynomial state representations and Gauss-Legendre collocation points were used.

\begin{figure}
	\centering
	\begin{tikzpicture}[%
		smallnode/.style={%
			circle, draw, minimum size=3mm, inner sep=0pt
		},
		r_smallnode/.style={%
			circle, draw, minimum size=3mm, inner sep=0pt, red
		},
		g_smallnode/.style={%
			circle, draw, minimum size=3mm, inner sep=0pt, mygreen
		},
		every path/.style={->, thick},
		x=1.5cm, y=1.5cm
		]
		
		\newcommand{\Plab}[2]{\bP^{#2}_{#1}}
		\definecolor{mygreen}{RGB}{0 150 0}
		
		% Nodes
		% First row
		\node[smallnode, label={[label distance=-2pt]above:\protect\(\Plab{k-2}{H-2}\)}] (Pk-2H-2) at (1,0) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k-1}{H-1}\)}] (Pk-1H-1) at (2,0) {};
		\node[g_smallnode, label={[label distance=-2pt]above:\(\Plab{k}{H}\)}] (PkH) at (3,0) {};
		\node[r_smallnode, label={[label distance=-2pt]above:\(\Plab{k+1}{0}\)}] (Pk+10) at (4,0) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k+2}{1}\)}] (Pk+21) at (5,0) {};
		
		% Second row
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k-2}{H-3}\)}] (Pk-2H-3) at (1,1) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k-1}{H-2}\)}] (Pk-1H-2) at (2,1) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k}{H-1}\)}] (PkH-1) at (3,1) {};
		\node[g_smallnode, label={[label distance=-2pt]above:\(\Plab{k+1}{H}\)}] (Pk+1H) at (4,1) {};
		\node[r_smallnode, label={[label distance=-2pt]above:\(\Plab{k+2}{0}\)}] (Pk+20) at (5,1) {};
		
		% dots row 
		\node[label={center,rotate=90:\(\dots\)}] (dots2) at (1, 1.7) {};
		\node[label={center,rotate=90:\(\dots\)}] (dots3) at (2, 1.7) {};
		\node[label={center,rotate=90:\(\dots\)}] (dots4) at (3, 1.7) {};
		\node[label={center,rotate=90:\(\dots\)}] (dots5) at (4, 1.7) {};
		\node[label={center,rotate=90:\(\dots\)}] (dots6) at (5, 1.7) {};
		
		% Third row 
		\node[g_smallnode, label={[label distance=-2pt]above:\(\Plab{k-2}{H}\)}] (Pk-2H) at (1,2) {};
		\node[r_smallnode, label={[label distance=-2pt]above:\(\Plab{k-1}{0}\)}] (Pk-10) at (2,2) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k}{1}\)}] (Pk1) at (3,2) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k+1}{2}\)}] (Pk+12) at (4,2) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k+2}{3}\)}] (Pk+23) at (5,2) {};
		
		% Fourth row
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k-2}{H-1}\)}] (Pk-2H-1) at (1,3) {};
		\node[g_smallnode, label={[label distance=-2pt]above:\(\Plab{k-1}{H}\)}] (Pk-1H) at (2,3) {};
		\node[r_smallnode, label={[label distance=-2pt]above:\(\Plab{k}{0}\)}] (Pk0) at (3,3) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k+1}{1}\)}] (Pk+11) at (4,3) {};
		\node[smallnode, label={[label distance=-2pt]above:\(\Plab{k+2}{2}\)}] (Pk+22) at (5,3) {};
		
		% Curved arrows
		\draw[bend left=20] (Pk-2H-2) to (Pk-1H-1);
		\draw[bend left=20] (Pk-1H-1) to (PkH);
		\draw[bend left=20] (Pk+10) to (Pk+21);
		
		\draw[bend left=20] (Pk-2H-3) to (Pk-1H-2);
		\draw[bend left=20] (Pk-1H-2) to (PkH-1);
		\draw[bend left=20] (PkH-1) to (Pk+1H);
		
		\draw[bend left=20] (Pk-10) to (Pk1);
		\draw[bend left=20] (Pk1) to (Pk+12);
		\draw[bend left=20] (Pk+12) to (Pk+23);
		
		\draw[bend left=20] (Pk-10) to (Pk1);
		\draw[bend left=20] (Pk1) to (Pk+12);
		\draw[bend left=20] (Pk+12) to (Pk+23);
		
		\draw[bend left=20] (Pk-2H-1) to (Pk-1H);
		\draw[bend left=20] (Pk0) to (Pk+11);
		\draw[bend left=20] (Pk+11) to (Pk+22);
		
		% Dashed rectangle
		\draw[dashed, thick, rounded corners] (2.6,-.25) rectangle (3.4,3.5);
		
	\end{tikzpicture}
	\caption{Schematic representation of the continuity and initialization Equations for the $H+1$ versions of the covariance matrix introduced in the discretized OCP. The dashed rectangle indicate the $k$-th step, in which the constraints are formulated. Each node represents a covariance matrix, labeled such that the subscript denotes the current grid step, while the superscript indicates the number of propagation steps it has undergone. At each step, two nodes are highlighted: the covariance matrix to be initialized (red node) and the matrix that has been propagated for $H$ steps (green node), which is used to formulate the robust constraints.}
	\label{fig:DOCPgrid}
\end{figure}

\subsection{Robust adherence constraint}
